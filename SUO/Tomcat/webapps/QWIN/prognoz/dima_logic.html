<html>
<head>
<script language="javascript">
function createXMLHttpRequest() {
  try { return new XMLHttpRequest(); } catch(e) {}
  try { return new ActiveXObject('Msxml2.XMLHTTP'); } catch (e) {}
  try { return new ActiveXObject('Microsoft.XMLHTTP'); } catch (e) {}
  throw 'XMLHttpRequest not supported';
}
 
var HTTP_TIMEOUT = 5; // default to 20s
 
// Sends an asynchronous XMLHttpRequest.
// onSuccess:function(req)
//    Function to be fired on completion.
// onFail : function(req)
//    Function to be fired on failure or timeout.  Note the req parameter
//    may be null.
// timeout: milliseconds
//    Request will be aborted if it hasn't completed within the timeout
//    period.  If not specified, default HTTP_TIMEOUT will be used.
//    Pass in -1 for infinite.
function httpRequest(url, onSuccess, onFail, postData, timeout) {
  // Prepare a new XMLHttpRequest instance
  var req = createXMLHttpRequest();
  var method = postData ? 'POST' : 'GET';
  req.open(method, url, true);
  //req.setRequestHeader('User-Agent', 'XMLHTTP/1.0');
  if (postData) {
    req.setRequestHeader('Content-type','application/x-www-form-urlencoded');
  }
  
  // Set up a timeout monitor if requested
  var timer = null;
  if (!timeout) timeout = HTTP_TIMEOUT;
  if (timeout != -1) {
    timer = setTimeout(httpTimeoutClosure(req, onFail), timeout);
  }

  // Hook status change event
  req.onreadystatechange = httpStatusChangeClosure(req, onSuccess, onFail, timer);
  
  req.send(postData);
}
  
function httpTimeoutClosure(req, onFail) {
  return function() {
    req.onreadystatechange = null;
    try {req.abort()}
    finally {if (onFail) onFail(req)}
  }
}


function httpStatusChangeClosure(req, onSuccess, onFail, timer) {
  return function() {
    if (req.readyState != 4) return;
    if (timer) clearTimeout(timer);
    if (req.status != 200 && req.status != 304) {
      if (onFail) onFail(req);
      return;
    }    
    if (onSuccess) onSuccess(req);
  }
}



// queue 
// [client][item]

var TIME_NO=90000;

var array_data=new Array();
var queue=new Array();
var matrix=new Array();


function load_queue(resp)
{
	var line_split,data;
	data=resp.split('%');
	line_split = data[0].split('#');
	
	for (var r=0; r <= line_split.length-1; r++) {
		items=line_split[r].split('^');
		queue.push([items[0],items[1],items[2],items[3],items[4]]);//line_split[r]
		//group rwt operation button level
		
	};
	
	
	line_split = data[1].split('#');
	for (var r=0; r <= line_split.length-2; r++) {
		items=line_split[r].split('^');
		alert(items);
		matrix.push([items[0],items[1],items[2],items[3],items[4],items[5],items[6],items[7],items[8],items[9],items[10],0]);//line_split[r]
		//group rwt operation button level
		
	};
};


function load() {
httpRequest('load.qsp2', function(req) { load_queue(req.responseText) }, function(req) {  }, null, 20000);
	
};

function ARRAY(i) {
	return array_data[i];
};

function BUTTON_QUEUE(i) {
	var count=0;
	for(var j in queue) {
		if (!queue.hasOwnProperty(j)) continue;
		if(queue[j][2] == i)
			count++;
	};
	return count;
};

function BUTTON_RWT(i) {
	var max=0;
	for(var j in queue) {
	//alert(queue[j]);
		if (!queue.hasOwnProperty(j)) continue;
		if((TIME_NO-queue[j][1])>=max && queue[j][2] == i)
			max=(TIME_NO-queue[j][1]);
	};
	return max;
};
function BUTTON_CALL(i) { //находим клиента с макс вр. ожид. по операции и удаляем его
	var max=0;
	var position=0;
	for(var j in queue) {
		if (!queue.hasOwnProperty(j)) continue;
		if((TIME_NO-queue[j][1])>=max && queue[j][2] == i) {
			max=(TIME_NO-queue[j][1]);
			position=j;
		};
	};
	delete queue[position];
	return true;
};

function GROUP_QUEUE_CUSTOMER_ITEM(i, j, item) {
	return;
};
/**
function max_rwt(array) //поиск макс. вр. ожид. кроме указаные операций (массив)
{
	max_rwt=0;
	id_oper=0;
    for (var i = 0; i < arr.length; i++) {
        if ((arr[i][0] == value) && (array.indexOf(arr[i][0]) == -1))
		{ 
			// if(max_rwt>=)
		};
	};
	return i;
}
**/
function step1(arr) {

	var max_rwt=0;
	var max_rwt_id=0;
	for (var i=0; i<=20; i++) {
	//поиск операции с максимальным временим ожидания
		if(	(BUTTON_RWT(i) >max_rwt) && (arr.indexOf(i) == -1)) {
			max_rwt=BUTTON_RWT(i);
			max_rwt_id=i;
		};
	};
	alert("max_rwt="+max_rwt+"   max_rwt_id"+max_rwt_id);
	return [max_rwt,max_rwt_id];
}

function step2(button) {
	var counter=0; var max_prog=0;
	var level=1;
	var arr=new Array();
	do {
	for(var j in matrix) {
		if (!matrix.hasOwnProperty(j)) continue;
		if((matrix[button+1] == level && counter ==0) || (matrix[button+1] == level && matrix[12]<max_prog)) {
			counter=matrix[0];
			max_prog=matrix[12];//время обслуживание
		};
	};
	
	if(arr.length >=19 )
		level=2;
		
	}while(true);
	return counter;
}
function step3(button) {
BUTTON_CALL();
};
</script>
</head>
<body>
<a onclick=load()>load()</a>
<div>
</div>
</body>
</html>