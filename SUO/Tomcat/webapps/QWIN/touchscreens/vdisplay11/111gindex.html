<html>
<head>
<meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
<meta http-equiv="cache-control" content="max-age=0" />
<meta http-equiv="cache-control" content="no-cache" />
<meta http-equiv="expires" content="0" />
<meta http-equiv="expires" content="Tue, 01 Jan 1980 1:00:00 GMT" />
<meta http-equiv="pragma" content="no-cache" />

<title>Сбербанк.Горизонтальное табло</title>

<script type="text/javascript" src="/js/qevent.js"></script><script src="js/jquery-1.7.2.min.js"></script>
		<script src="js/index.js"></script>
<style>
BODY{
overflow: hidden;
}
</style>
<!-- new method BEGIN-->
<!--new method END -->
<script type="text/javascript">
//global var
displayStack = [];
rx = /([А-Я])\sLETTER\s(\d{3})\s\NUMBER\s\w+\sBUTTON\s(\d{1,2})\sOKNO/;

//new method BEGIN
$( function() {
	//первичная инициализация табло при загрузке, отображаем те талоны, которые уже обслуживаются
    $.ajax( "/touchscreens/vdisplay/includes/counter_info.qsp2", {
        cache: false,
        async:false,
        dataType: "html",
        error: onErrorStartup,
        success: onSuccesStartup
    });

function onSuccesStartup(resp){
		var array_result = resp.split(';');
		var tempTicketArray =[];
	$.each(array_result,function(i,val){
		if (val != "") {
			var tmpTicketData = val.split(':');
			
			//проверка на корректность номеров талонов
			if (tmpTicketData[1]!="-" && tmpTicketData[1]!='n'  && typeof tmpTicketData[1]!=='undefined') {
				var btn = tmpTicketData[1];
				var num = tmpTicketData[2];
				var wind = tmpTicketData[0];
				var timeServ = parseInt(tmpTicketData[3],10);
				tempTicketArray.push({letter:btn,number:num, win:normalizeWindowNumber(wind), time:timeServ});
			};
			
		};
	});
	sortByTime(tempTicketArray);
	$.each(tempTicketArray,function(i,val){
		displayStack.push({letter:val.letter, number:val.number, win:val.win, time:val.time});
	})
	showTicketsStack();
}

function onErrorStartup(data){
}

//привеодит строку к 2х символьному виду
function normalizeWindowNumber(num){
	while(num.length<2){
		num = "0"+num;
	}
	return num;
}

function showTicketsStack(){
		var outhtml ="";
		outhtml=outhtml+"<center>";
		if (displayStack.length<1) {
			$('#infoqq').html('<center></center>'); //если нет талонов очищаем все поле 
			return;
		}
		var tempDisplayData = [];

		//реверсим массив во временный для удобства отображения
		for (var i = displayStack.length - 1; i >= 0; i--) {
			tempDisplayData.push(displayStack[i]);
		};

		$.each(tempDisplayData,function(i,val){
			if (i>4) return; //если уже данных более 5 то выходим
			if(val.time < 15) {
				outhtml=outhtml+"<font id=num_call_"+i+"  color='RED' style='font-size:130px;font-weight: bold;font-family: Geneva, Arial, Helvetica, sans-serif;'>"+val.letter+""+val.number+"&rarr;"+val.win+"</font><br><br>";
			} else {
				outhtml=outhtml+"<font id=num_call_"+i+"  color='WHITE' style='font-size:130px;font-weight: bold;font-family: Geneva, Arial, Helvetica, sans-serif;'>"+val.letter+""+val.number+"&rarr;"+val.win+"</font><br><br>";
			};
		});
		outhtml=outhtml+"</center>";
		$('#infoqq').html(outhtml);
};

//сортировка первичного массива по времени обслуживания
function sortByTime(tempTicketArray){
	tempTicketArray.sort(function(a,b){
		if (a.time<b.time) {
			return 1;
		}else
		if(a.time>b.time){
			return -1;
		}
		return 0;
	})
}

qwin_event.trig = function(eventType, unit, result){
	if(unit == 1) {
		if (eventType==112) {// если вызов
			var rawstr = result;
			
			//alert(result);
			var mtch = rx.exec(rawstr);
			displayStack.push({letter:mtch[1],number:mtch[2], win:normalizeWindowNumber(mtch[3])});
			showTicketsStack();

		};
		if (eventType==113) { //если завершение
			var rawstr1 = result;
			//alert(result);
			var mtch1 = rx.exec(rawstr1);
			for (var i = 0; i<= displayStack.length-1; i++) {
				var val = displayStack[i];
				if (val.win==normalizeWindowNumber(mtch1[3])) {
					displayStack.splice($.inArray(val,displayStack),1);
				}
			};
			showTicketsStack();
		};
		
		
	};
};

qwin_event.setEvents = function(){
	qwin_event.waitForEventTrig("112.113");
};

qwin_event.setEvents();
});
//new method END

</script>
</head>

<body bgcolor="4fa340" leftmargin="0" rightmargin="0" topmargin="0" bottommargin="0"  cellpadding=0 cellspacing=0 background='bg.jpg' scroll=no >
<table border=0 leftmargin="0" rightmargin="0" topmargin="0" bottommargin="0" height=1366 width=768>
<tr height=180><td></td></tr>
<tr height=1016><td valign=top><div id='infoqq' valign=top height=1016></div></td></tr>
<tr height=170><td>

</td></tr>
</table>
<div id='strok' style="z-index: 500; position: absolute; white-space: nowrap; top: 1196px; height: 170px;display: block; ">
	<font color="WHITE" style='font-size:80px;font-weight: bold;font-family: Geneva, Arial, Helvetica, sans-serif;'><b id='inside_strok'></b></font>				
</div>
</body>
</html>
