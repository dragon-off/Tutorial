<!DOCTYPE HTML PUBLIC  "loose.dtd">
<html>
<head><META HTTP-EQUIV="Pragma" CONTENT="no-cache">
<meta http-equiv="Content-Type" content="text/html; charset=utf-8">
<script type="text/javascript" src="js/ajax.js"></script> 
<META HTTP-EQUIV="Expires" CONTENT="-1">
<title>Journal</title>
<LINK REL="StyleSheet" HREF="style.css" TYPE="text/css">
<script language='javascript'>
function close_salert(el)
{
var elem = parent.frames[0].document.getElementById('blockres');
elem.innerHTML=elem.innerHTML*1-1;
if(el==2) elem.innerHTML=0;
var messages = elem.innerHTML*1;
if(messages<0)
	{
	messages=0;
	elem.innerHTML=0;
	}
if(messages==0)
	parent.frames[0].document.getElementById('block').style.display = 'none';
parent.frames[1].document.getElementById('message_box_'+el+'_text').innerHTML="";
if(el==1)
	parent.frames[1].document.getElementById('message_box_3_text').innerHTML="";
}

var koltri =0;
function hide_tr(a)
{

if(a< koltri)
	{
	for(var i=a;i<=koltri;i++)
		{
		if(!document.getElementById('tr-i-'+i)) koltri=i-1;
		else
		document.getElementById('tr-i-'+i).style.display = 'none';
		}
	koltri = a;
	}

}
function DECI_to_HEX ( num ) {
  var x = '';
  x += "0123456789ABCDEF".charAt((num-num%16)/16)
      + "0123456789ABCDEF".charAt(num%16);
  return x;
  }
  function hexQuot(i) {
            return Math.floor(i/16);
        }
 function itohex(m) {hexChars = '0123456789ABCDEF';return hexChars.charAt(m);}
 function dec2hex(i) {
	a2 = '';
	ihex = hexQuot(i);
	idiff = i-(ihex*16);
	a2 = itohex(idiff) + a2;
	while( ihex >= 16) {
		itmp = hexQuot(ihex);
		idiff = ihex-(itmp*16);
		a2 = itohex(idiff) + a2;
		ihex = itmp;
	} 
	a1 = itohex(ihex);
	res = a1 + a2+'';
	while(res.length%2!=0) res = '0'+res;
	return res ;
 }
function strtouni(str)
{
var len = str.length;
var out ="";
for(var i=0;i<len;i++)
	{
	out+="|u"+dec2hex(str.charCodeAt(i))+"";
	}
out=encodeURIComponent(str);
	return out;
}
function update_result(str)
{
str = str.split('<br>');

var len=str.length;
var tr=new Array();
for(var i=1;i<len-1;i++)
	{
	if(document.getElementById('tr-i-'+i))
		{
		tr[i]=document.getElementById('tr-i-'+i);
		tr[i].style.display = 'block';
		koltri++; 
		}
	else
		{
		tr[i] = document.createElement('tr');
		tr[i].id = 'tr-i-'+i;
		koltri++; 
		}
	if(i%2==0)
		tr[i].style.backgroundColor = "#eeeeee";
	tr[i].style.height = "30px";
	document.getElementById('journal_body').appendChild(tr[i]);
	var row = str[i].split('|');
	var td=new Array();
	for(var j=0;j<4;j++)
		{
		var this_id = 'ifns-td-'+((i)*4+j+1);
		if(document.getElementById(this_id))
			td[j]=document.getElementById(this_id);
		else
			{
			td[j] = document.createElement('td');
			td[j].id = this_id;
			tr[i].appendChild(td[j]);
			}
		if(j==0) row[j]= row[j]*1;
		td[j].className = "tableBody";
		td[j].innerHTML = row[j];
		}
	}
hide_tr(len-1);
}
function update(http_url)
{
	httpRequest(http_url, function(req) { update_result(req.responseText) }, function(req) { }, null, 3000);
};
function selectf()
{
var event = document.getElementById('event').value;
var user = document.getElementById('user').value;
var touser = document.getElementById('touser').value;
var toobj = document.getElementById('toobj').value;
var date = document.getElementById('date').value;
var time = document.getElementById('time').value;

var eventstr = "*";
if(event!="") eventstr+=event+"*";
if(touser!="") eventstr+=touser+"*";
if(toobj!="") eventstr+=toobj+"*";

if(user!="") user="*"+user+"*";

var dd = new Array(0);
var mm = new Array(0);
var yy = new Array(1990);
var hh = new Array(0);
var mi = new Array(0);
var sec = new Array(0);

date = date.split('-');
var err1 = 0;
if(date.length>3 && date[0]=="") err1=1;
else
	{
	var d = new Array();
	for(var i=0; i<date.length && err1==0; i++)
		{
		d[i] = date[i].split('.');
		if((d[i].length<3 || d[i].length>3) && d[i][0]!="") err1=1;
		else
			{
			dd[i] = d[i][0]*1;
			mm[i] = d[i][1]*1;
			yy[i] = d[i][2]*1;
			}
		}
	}
if(err1==1) alert("Дата введена не правильно!Формат даты дд.мм.гггг, либо интервал дат дд.мм.гггг-дд.мм.гггг");
else 
	{
	/*dd = date[0]*1;
	mm = date[1]*1;
	yy = date[2]*1;*/
	
	
	/*time = time.split(':');
	if((time.length<2 || time.length>3) && time[0]!="") alert("Время введено не правильно!Формат времени чч:мм:сс или чч:мм, либо временной период чч:мм:сс-чч:мм:сс");*/
	time = time.split('-');
	var err = 0;
	if(time.length>2 && time[0]=="") err=1;
	else
		{
		var t = new Array();
		for(var i=0; i<time.length && err==0; i++)
			{
			t[i] = time[i].split(':');
			if(((t[i].length<2 || t[i].length>3) && t[i][0]!="") || (i==1 && t[i].length!=t[0].length)) err=1;
			else
				{
								
				hh[i] = t[i][0]*1;
				mi[i] = t[i][1]*1;
				if(t[i].length==2)
					{
					if(i==1)
						sec[i] = 0;
					else
						{
						if(time.length==1)
							sec[i] = 70;
						else
							sec[i] = 0;
						}
					}
				else
					{
					sec[i] = t[i][2]*1;
					}
				}
			}
		}
	if(err==1) alert("Время введено не правильно!Формат времени чч:мм:сс или чч:мм, либо временной период чч:мм:сс-чч:мм:сс, чч:мм-чч:мм");
	else
		{
		/*hh = time[0]*1;
		mi = time[1]*1;
		if(time.length==2)
			sec = 70;
		else
			sec = time[2]*1;*/
		var isfirst=0;
		var outstr = 'journal.jsp';
		if(eventstr!='*')
			{
			if(isfirst==0) {outstr+="?"; isfirst=1;}
			else outstr+="&";
			outstr+="event="+strtouni(eventstr);
			}
		if(user!='')
			{
			if(isfirst==0) {outstr+="?"; isfirst=1;}
			else outstr+="&";
			outstr+="user="+user;
			}
		if(date[0]!="")
			{
			if(isfirst==0) {outstr+="?"; isfirst=1;}
			else outstr+="&";
			outstr+="day="+dd[0];
			outstr+="&";
			outstr+="month="+mm[0];
			outstr+="&";
			outstr+="year="+yy[0];
			if(dd.length>1)
				{
				outstr+="&";
				outstr+="today="+dd[1];
				outstr+="&";
				outstr+="tomonth="+mm[1];
				outstr+="&";
				outstr+="toyear="+yy[1];
				}
			}
		if(time[0]!="")
			{
			if(isfirst==0) {outstr+="?"; isfirst=1;}
			else outstr+="&";
			outstr+="hour="+hh[0];
			outstr+="&";
			outstr+="min="+mi[0];
			outstr+="&";
			outstr+="sec="+sec[0];
			if(hh.length>1)
				{
				outstr+="&";
				outstr+="tohour="+hh[1];
				outstr+="&";
				outstr+="tomin="+mi[1];
				outstr+="&";
				outstr+="tosec="+sec[1];
				}
			}
			
		//document.getElementById('test').innerHTML = "<a href="+outstr+">test</a>";
		update(outstr);
		}
	}


}
</script>
</head>
<body style="margin:0px;padding:0px;" onload="selectf();">
<div id="test"></div>
<table cellpadding=0 cellspacing=0 width="100%" height="50px">
	<tr>
		<td>
		<div class="filtres">Событие<br><input type="text" value="" id="event"/></div>
		<div class="filtres">Пользователь<br><input type="text" value="" id="user"/></div>
		<div class="filtres">Над пользователем<br><input type="text" value="" id="touser"/></div>
		<div class="filtres">Над объектом<br><input type="text" value="" id="toobj"/></div>
		<div class="filtres">Дата<br><input type="text" value="" id="date"/></div>
		<div class="filtres">Время<br><input type="text" value="" id="time"/></div>
		<div class="filtres" style="float:right;"><input id="show_button" type="button" onClick="selectf();" value="Показать"/></div><br>
		<!--*Дату и время можно указывать как диапазоном, так и конкретную, например дата (12.04.2013-14.04.2013 или 13.04.2013), время (9:00-11:00 или 10:00) -->
		</td>
	</tr>
</table>
<table cellpadding=0 cellspacing=0 width="100%">
<tbody id="journal_body">
<tr height="30px">
	<td class="tableHead" width="20px" style="width:20px;text-align:center;">#</td>
	<td class="tableHead" width="200px" style="width:200px;text-align:center;">Пользователь</td>
	<td class="tableHead" width="250px" style="width:250px;text-align:center;">Дата/Время</td>
	<td class="tableHead" style="text-align:center;border-right-color:#E0E0E1;">Событие</td>
</tr>

</tbody>
</table>

<table width='100%' height='100%' id="message_box_1" style="height:100%;width:100%;position: absolute;left:0px;top:0px;display:none;z-index:998; background-image:url('halfpixel.png');">
<tr>
<td style="text-align:center;">
<div class="error_box" >
<table cellpadding=0 cellspacing=0 border=0 style="height:100%;width:100%;">
	<tr height='58px'>
		<td>
			<div style="border-bottom:solid 1px #f43839;height: 58px;background-color: #fccac1;width:100%;">
			<table cellpadding=0 cellspacing=0 border=0 style="height:100%;width:100%;">
				<tr>
					<td style="padding:9px;">
						<img src='error.gif' border=0/>
					</td>
					<td style="padding:9px; font-family: Arial, sans-serif;font-size:14pt;text-transform:uppercase;color:#f43839;text-align:center;">
						Внимание!
					</td>
					<td style="padding:9px;text-align:right;">
						<img src='close_error.gif' style="cursor:pointer;" onClick="close_salert(1); document.getElementById('message_box_1').style.display='none';" border=0/>
					</td>
					
				</tr>
			</table>
			</div>
		</td>
	</tr>
	<tr>
		<td style="padding:5px;vertical-align:top;" id="message_box_1_text">

		</td>
	</tr>
	<tr>
		<td style="padding:5px;vertical-align:top;" id="message_box_3_text">

		</td>
	</tr>
	<tr>
		<td>
		<div style="border-top:solid 1px #f43839;height: 38px;background-color: #fccac1;width:100%;text-align:center;">
			<input type="button" value="OK" onClick="close_salert(1); document.getElementById('message_box_1').style.display='none';" style="height:35px;width:80%;">
			</div>
		</td>
	</tr>
</table>
</div>
</td>
</tr>
</table>
<table width='100%' height='100%' id="message_box_2" style="height:100%;width:100%;position: absolute;left:0px;top:0px;display:none;z-index:997;background-image:url('halfpixel.png');">
<tr>
<td style="text-align:center;">
<div class="error_box" >
<table cellpadding=0 cellspacing=0 border=0 style="height:100%;width:100%;">
	<tr height='58px'>
		<td>
			<div style="border-bottom:solid 1px #f43839;height: 58px;background-color: #fccac1;width:100%;">
			<table cellpadding=0 cellspacing=0 border=0 style="height:100%;width:100%;">
				<tr>
					<td style="padding:9px;">
						<img src='error.gif' border=0/>
					</td>
					<td style="padding:9px; font-family: Arial, sans-serif;font-size:14pt;text-transform:uppercase;color:#f43839;text-align:center;">
						Внимание!
					</td>
					<td style="padding:9px;text-align:right;">
						<img src='close_error.gif' style="cursor:pointer;" onClick="close_salert(2); document.getElementById('message_box_2').style.display='none';" border=0/>
					</td>
				</tr>
			</table>
			</div>
		</td>
	</tr>
	<tr>
		<td style="padding:5px;vertical-align:top;" id="message_box_2_text">

		</td>
	</tr>
</table>
</div>
</td>
</tr>
</table>
<table width='100%' height='100%'  style="height:100%;width:100%;position: absolute;left:0px;top:0px;display:none;z-index:999;background-image:url('halfpixel.png');">
<tr>
<td style="text-align:center;">
<div class="error_box" >
<table cellpadding=0 cellspacing=0 border=0 style="height:100%;width:100%;">
	<tr height='58px'>
		<td>
			<div style="border-bottom:solid 1px #f43839;height: 58px;background-color: #fccac1;width:100%;">
			<table cellpadding=0 cellspacing=0 border=0 style="height:100%;width:100%;">
				<tr>
					<td style="padding:9px;">
						<img src='error.gif' border=0/>
					</td>
					<td style="padding:9px; font-family: Arial, sans-serif;font-size:14pt;text-transform:uppercase;color:#f43839;text-align:center;">
						Внимание!
					</td>
					<td style="padding:9px;text-align:right;">
						<img src='close_error.gif' style="cursor:pointer;" onClick="close_salert(3); document.getElementById('message_box_3').style.display='none';" border=0/>
					</td>
				</tr>
			</table>
			</div>
		</td>
	</tr>
	<tr>
		<td style="padding:5px;vertical-align:top;" id="message_box_3_text">

		</td>
	</tr>
</table>
</div>
</td>
</tr>
</table>
</body>
</html>